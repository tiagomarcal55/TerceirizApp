<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Custos e Precificação - Serviços de Limpeza</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary': '#434E6E', 'secondary': '#7A8299', 'accent': '#64748b', 'surface': '#ffffff', 'background': '#f8fafc', 'on-primary': '#ffffff', 'on-surface': '#1e293b', 'success': '#16a34a', 'warning': '#f59e0b', 'danger': '#dc2626' }
                }
            }
        }
        .expandable-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .expandable-content.expanded { max-height: 1500px; /* Increased max-height */ }
        .group-card-enter { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-background text-on-surface antialiased">

    <div class="min-h-screen flex flex-col items-center justify-center p-4 lg:p-8">
        <div class="w-full max-w-7xl mx-auto">
            
            <header class="mb-8 text-center">
                <h1 class="text-4xl font-bold text-primary tracking-tight">Dashboard de Custos e Precificação</h1>
                <p class="text-lg text-secondary mt-2">Análise completa para otimização de contratos.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 flex flex-col gap-8">
                    <!-- Container for dynamic employee parameter groups -->
                    <div id="parameter-groups-container" class="space-y-6"></div>
                    
                    <div class="text-center">
                        <button id="add-group-btn" class="w-full bg-primary/10 text-primary font-semibold py-3 px-4 rounded-xl hover:bg-primary/20 transition-all flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                            Adicionar Novo Grupo de Funcionários
                        </button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-surface p-8 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-primary mb-6">Simulador de Contrato</h2>
                    
                    <div class="mb-8">
                        <label class="block text-sm font-medium text-secondary mb-2">Configuração de Equipe</label>
                        <div id="employee-rows-container" class="space-y-3"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 items-end">
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label for="aliquotaSimples" class="block text-sm font-medium text-secondary">Alíquota de Imposto (%)</label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="aliquotaAutomaticaSwitch" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                    <span class="ml-3 text-sm font-medium text-secondary">Auto</span>
                                </label>
                            </div>
                            <input type="number" id="aliquotaSimples" value="6.0" step="0.1" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition" title="Alíquota calculada automaticamente. Desative o modo 'Auto' para inserir manualmente.">
                        </div>
                        <div>
                           <label for="valorContrato" class="block text-sm font-medium text-secondary mb-1">Valor Mensal do Contrato (R$)</label>
                            <input type="number" id="valorContrato" value="" placeholder="Informe o valor do contrato" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition placeholder-slate-400">
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-xl border">
                        <h3 class="text-lg font-semibold text-primary mb-4">Análise Financeira do Contrato</h3>
                        <div class="flex flex-wrap justify-center gap-4">
                            <div class="bg-white p-4 rounded-lg border text-center flex-1 min-w-[150px]">
                                <p class="text-sm text-secondary">Custo Total</p>
                                <p id="dashCustoTotal" class="text-xl xl:text-2xl font-bold text-primary mt-1">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center flex-1 min-w-[150px]">
                                <p class="text-sm text-secondary">Impostos</p>
                                <p id="dashImpostos" class="text-xl xl:text-2xl font-bold text-danger mt-1">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center flex-1 min-w-[150px]">
                                <p class="text-sm text-secondary">Lucro Líquido</p>
                                <p id="dashLucroLiquido" class="text-xl xl:text-2xl font-bold text-success mt-1">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center flex-1 min-w-[150px]">
                                <p class="text-sm text-secondary">Margem</p>
                                <p id="dashMargemReal" class="text-xl xl:text-2xl font-bold text-primary mt-1">0.0%</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center flex-1 min-w-[150px]">
                                <p class="text-sm text-secondary">Fator R</p>
                                <p id="dashFatorR" class="text-xl xl:text-2xl font-bold text-primary mt-1">0.0%</p>
                            </div>
                        </div>
                        
                        <div id="analiseViabilidade" class="mt-6 text-center bg-primary text-on-primary p-4 rounded-lg">
                            Preencha o valor do contrato para ver a análise de viabilidade.
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let parameterGroups = [];
        let nextGroupId = 1;

        // --- ELEMENT SELECTORS ---
        const globalInputs = {
            aliquotaSimples: document.getElementById('aliquotaSimples'),
            aliquotaAutomaticaSwitch: document.getElementById('aliquotaAutomaticaSwitch'),
            valorContrato: document.getElementById('valorContrato'),
        };
        const containers = {
            parameterGroups: document.getElementById('parameter-groups-container'),
            employeeRows: document.getElementById('employee-rows-container'),
        };
        const buttons = {
            addGroup: document.getElementById('add-group-btn'),
        };
        const outputs = {
            dashCustoTotal: document.getElementById('dashCustoTotal'),
            dashImpostos: document.getElementById('dashImpostos'),
            dashLucroLiquido: document.getElementById('dashLucroLiquido'),
            dashMargemReal: document.getElementById('dashMargemReal'),
            dashFatorR: document.getElementById('dashFatorR'),
            analiseViabilidade: document.getElementById('analiseViabilidade'),
        };

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        function getAliquotaSimples(faturamentoAnual, fatorR) {
            const anexo = fatorR >= 0.28 ? 'III' : 'V';
            const faixas = {
                'III': [
                    { limite: 180000, aliquota: 6.0 }, { limite: 360000, aliquota: 11.2 },
                    { limite: 720000, aliquota: 13.5 }, { limite: 1800000, aliquota: 16.0 },
                    { limite: 3600000, aliquota: 21.0 }, { limite: 4800000, aliquota: 33.0 }
                ],
                'V': [
                    { limite: 180000, aliquota: 15.5 }, { limite: 360000, aliquota: 18.0 },
                    { limite: 720000, aliquota: 19.5 }, { limite: 1800000, aliquota: 20.5 },
                    { limite: 3600000, aliquota: 23.0 }, { limite: 4800000, aliquota: 30.5 }
                ]
            };
            for (const faixa of faixas[anexo]) {
                if (faturamentoAnual <= faixa.limite) return faixa.aliquota;
            }
            return faixas[anexo][faixas[anexo].length - 1].aliquota;
        }

        // --- CORE CALCULATION LOGIC ---
        function calculateBaseCostForGroup(groupId) {
            const groupCard = document.getElementById(`parameter-group-${groupId}`);
            if (!groupCard) return null;

            const getVal = (selector) => parseFloat(groupCard.querySelector(selector).value) || 0;
            const isChecked = (selector) => groupCard.querySelector(selector).checked;
            
            const salario = getVal('.salarioBase');
            const va = getVal('.valeAlimentacao');
            const vt = getVal('.valeTransporte');
            const vtDescontoAtivo = isChecked('.valeTransporteDescontoSwitch');

            const descontoVA = va * 0.20;
            const descontoVT = vtDescontoAtivo ? Math.min(salario * 0.06, vt) : 0;

            const custosDiretosDetails = [
                { item: 'Salário Base', valor: salario },
                { item: 'Vale Alimentação', valor: va - descontoVA },
                { item: 'Vale Transporte', valor: vt - descontoVT },
                { item: 'Uniformes e EPIs', valor: getVal('.custoUniformes') },
                { item: 'Contabilidade', valor: getVal('.custoContabilidade') },
                { item: 'Outros', valor: getVal('.custoOutros') },
            ];
            const encargosDetails = [
                { item: 'FGTS', valor: salario * 0.08 },
                { item: 'Seguro Acidente (RAT)', valor: salario * 0.01 },
            ];
            const provisoesDetails = [
                { item: '13º Salário', valor: salario / 12 },
                { item: 'Férias + 1/3', valor: (salario * 1.3333) / 12 },
                { item: 'FGTS s/ 13º e Férias', valor: ((salario + (salario / 3)) * 0.08) / 12 },
                { item: 'Multa FGTS (40%)', valor: (salario * 0.08 * 12 * 0.40) / 12 },
                { item: 'Aviso Prévio Indenizado', valor: salario / 12 },
                { item: 'Documentações Obrigatórias', valor: 1060 / 12 },
            ];
            const operacionaisDetails = [
                { item: 'Cobertura de Faltas/Férias', valor: 250 },
                { item: 'Seguro de Vida', valor: 15 },
                { item: 'Supervisão e Gestão', valor: 50 },
            ];
            
            const sumTotal = (details) => details.reduce((sum, item) => sum + item.valor, 0);

            const allCosts = {
                salarioBase: salario,
                custosDiretos: { total: sumTotal(custosDiretosDetails), details: custosDiretosDetails },
                encargos: { total: sumTotal(encargosDetails), details: encargosDetails },
                provisoes: { total: sumTotal(provisoesDetails), details: provisoesDetails },
                operacionais: { total: sumTotal(operacionaisDetails), details: operacionaisDetails },
            };
            
            allCosts.custoTotal = allCosts.custosDiretos.total + allCosts.encargos.total + allCosts.provisoes.total + allCosts.operacionais.total;
            return allCosts;
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateCostBreakdownForGroup(groupId, baseCost) {
            const groupCard = document.getElementById(`parameter-group-${groupId}`);
            if (!groupCard || !baseCost) return;

            const costBreakdownContainer = groupCard.querySelector('.cost-breakdown');
            costBreakdownContainer.innerHTML = '';
            
            const categories = [
                { title: 'Custos Diretos', data: baseCost.custosDiretos },
                { title: 'Encargos', data: baseCost.encargos },
                { title: 'Provisões', data: baseCost.provisoes },
                { title: 'Custos Operacionais', data: baseCost.operacionais },
            ];

            categories.forEach(cat => {
                let detailsHTML = cat.data.details.map(item => `
                    <tr class="text-xs border-t">
                        <td class="py-1 pr-2 text-slate-600">${item.item}</td>
                        <td class="py-1 pl-2 font-medium text-right">${formatCurrency(item.valor)}</td>
                    </tr>`).join('');

                costBreakdownContainer.innerHTML += `
                    <div>
                        <button class="w-full flex justify-between items-center py-1 text-sm expand-category-btn">
                            <span class="font-medium text-secondary">${cat.title}</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-on-surface mr-2">${formatCurrency(cat.data.total)}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-secondary transition-transform"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                        </button>
                        <div class="expandable-content pl-4">
                            <table class="w-full mt-1">${detailsHTML}</table>
                        </div>
                    </div>`;
            });
            groupCard.querySelector('.custoTotalMensalFuncionario').textContent = formatCurrency(baseCost.custoTotal);
        }

        function calculateAndRenderAll() {
            // Step 1: Calculate costs for all existing groups and store them.
            const costsByGroup = {};
            parameterGroups.forEach(group => {
                const baseCost = calculateBaseCostForGroup(group.id);
                if (baseCost) {
                    costsByGroup[group.id] = baseCost;
                    updateCostBreakdownForGroup(group.id, baseCost);
                }
            });

            // Step 2: Calculate total operation cost based on employee rows.
            let custoTotalOperacao = 0;
            let folhaSalarialTotal = 0;
            const employeeRows = containers.employeeRows.querySelectorAll('.employee-row');
            
            employeeRows.forEach(row => {
                const horas = parseFloat(row.querySelector('.horas-input').value) || 0;
                const qtd = parseInt(row.querySelector('.qtd-input').value) || 0;
                const selectedGroupId = row.querySelector('.group-select').value;
                
                if (horas > 0 && qtd > 0 && costsByGroup[selectedGroupId]) {
                    const baseCost = costsByGroup[selectedGroupId];
                    const fatorCargaHoraria = horas / 44;
                    custoTotalOperacao += baseCost.custoTotal * qtd * fatorCargaHoraria;
                    folhaSalarialTotal += baseCost.salarioBase * qtd * fatorCargaHoraria;
                }
            });
            
            outputs.dashCustoTotal.textContent = formatCurrency(custoTotalOperacao);

            // Step 3: Calculate financial analysis.
            const valorContrato = parseFloat(globalInputs.valorContrato.value) || 0;
            const fatorR = (valorContrato > 0) ? (folhaSalarialTotal / valorContrato) : 0;
            outputs.dashFatorR.textContent = `${(fatorR * 100).toFixed(1)}%`;
            outputs.dashFatorR.classList.toggle('text-success', fatorR >= 0.28);
            outputs.dashFatorR.classList.toggle('text-warning', fatorR < 0.28);

            let aliquotaImpostoPercentual = 0;
            if (globalInputs.aliquotaAutomaticaSwitch.checked) {
                aliquotaImpostoPercentual = getAliquotaSimples(valorContrato * 12, fatorR);
                globalInputs.aliquotaSimples.value = aliquotaImpostoPercentual.toFixed(1);
            } else {
                aliquotaImpostoPercentual = parseFloat(globalInputs.aliquotaSimples.value) || 0;
            }
            
            const impostos = valorContrato * (aliquotaImpostoPercentual / 100);
            const lucroLiquido = valorContrato - impostos - custoTotalOperacao;
            const margemReal = valorContrato > 0 ? (lucroLiquido / valorContrato) : 0;

            outputs.dashImpostos.textContent = formatCurrency(impostos);
            outputs.dashLucroLiquido.textContent = formatCurrency(lucroLiquido);
            outputs.dashMargemReal.textContent = `${(margemReal * 100).toFixed(1)}%`;
            outputs.dashLucroLiquido.classList.toggle('text-success', lucroLiquido > 0);
            outputs.dashLucroLiquido.classList.toggle('text-danger', lucroLiquido < 0);

            let analiseHTML = '';
            if (valorContrato === 0) {
                analiseHTML = 'Preencha o valor do contrato para ver a análise de viabilidade.';
            } else if (lucroLiquido < 0) {
                analiseHTML = `<p class="text-sm"><strong>Atenção: Prejuízo!</strong> O contrato opera com déficit de <strong class="text-red-300">${formatCurrency(Math.abs(lucroLiquido))}</strong>.</p>`;
            } else {
                analiseHTML = `<p class="text-sm"><strong>Operação Viável.</strong> O contrato gera um lucro líquido de <strong class="text-green-300">${formatCurrency(lucroLiquido)}</strong>.</p>`;
            }
            outputs.analiseViabilidade.innerHTML = analiseHTML;
        }

        // --- DYNAMIC ELEMENT MANAGEMENT ---
        function createParameterGroup() {
            const groupId = nextGroupId++;
            const groupName = `Grupo ${groupId}`;

            const groupCard = document.createElement('div');
            groupCard.id = `parameter-group-${groupId}`;
            groupCard.className = 'parameter-group bg-surface p-6 rounded-2xl shadow-sm border border-slate-200 group-card-enter';
            groupCard.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <input type="text" value="${groupName}" class="group-name-input text-xl font-semibold text-primary bg-transparent focus:ring-0 focus:border-b-2 border-primary/20 focus:outline-none w-full" placeholder="Nome do Grupo">
                    <button class="remove-group-btn p-1 text-slate-400 hover:text-danger transition rounded-full" ${parameterGroups.length > 0 ? '' : 'style="visibility: hidden;"'}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                <!-- Main Parameters -->
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-secondary mb-1">Salário Base (R$)</label><input type="number" value="1764" class="salarioBase w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-secondary mb-1">Vale Alimentação (R$)</label><input type="number" value="805" class="valeAlimentacao w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-secondary mb-1">Vale Transporte (R$)</label><input type="number" value="360" class="valeTransporte w-full p-2 border rounded-lg"></div>
                    <div class="flex items-center justify-between pt-2"><span class="text-sm font-medium text-secondary">Desconto VT (6%)</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="valeTransporteDescontoSwitch sr-only peer" checked><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div>
                    <div class="pt-2 text-right"><button class="expand-params-btn inline-flex items-center text-sm font-medium text-primary hover:text-accent"><span>Custos Adicionais</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 ml-1"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div>
                    <div class="additional-params expandable-content space-y-4 pt-4 border-t">
                        <div><label class="block text-sm font-medium text-secondary mb-1">Uniformes/EPIs (R$)</label><input type="number" value="100" class="custoUniformes w-full p-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-secondary mb-1">Contabilidade (p/ func.)</label><input type="number" value="165" class="custoContabilidade w-full p-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-secondary mb-1">Outros Custos (R$)</label><input type="number" value="0" class="custoOutros w-full p-2 border rounded-lg"></div>
                    </div>
                </div>
                <!-- Cost Breakdown for this group -->
                <div class="mt-6 pt-4 border-t-2">
                    <h3 class="text-lg font-semibold text-primary mb-2">Custo Real do Funcionário (44h)</h3>
                    <div class="cost-breakdown space-y-2"></div>
                    <div class="border-t mt-4 pt-4 flex justify-between items-center text-base">
                        <span class="font-semibold text-primary">Custo Total Mensal</span>
                        <span class="custoTotalMensalFuncionario font-bold text-primary text-lg">R$ 0,00</span>
                    </div>
                </div>
            `;
            containers.parameterGroups.appendChild(groupCard);
            parameterGroups.push({ id: groupId, name: groupName });
            updateAllGroupDropdowns();
            updateRemoveGroupButtons();
            calculateAndRenderAll();
        }

        function createEmployeeRow() {
            const row = document.createElement('div');
            row.className = 'employee-row grid grid-cols-[1fr_auto_1fr_1fr_auto_auto] items-center gap-3';
            row.innerHTML = `
                <input type="number" value="44" class="horas-input w-full p-2 border rounded-lg" placeholder="Horas/sem">
                <span class="text-secondary text-center">x</span>
                <input type="number" value="1" min="1" class="qtd-input w-full p-2 border rounded-lg" placeholder="Qtd.">
                <select class="group-select w-full p-2 border rounded-lg bg-white"></select>
                <button class="remove-row-btn p-2 text-slate-400 hover:text-danger transition rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5"><path d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                </button>
                <button class="add-row-btn p-2 text-slate-400 hover:text-primary transition rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5"><path d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                </button>
            `;
            containers.employeeRows.appendChild(row);
            updateRemoveRowButtons();
            updateAllGroupDropdowns();
        }
        
        function updateAllGroupDropdowns() {
            const optionsHTML = parameterGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            document.querySelectorAll('.group-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = optionsHTML;
                // Preserve selection if possible
                if (Array.from(select.options).some(opt => opt.value === currentVal)) {
                     select.value = currentVal;
                }
            });
            calculateAndRenderAll();
        }

        function updateRemoveGroupButtons() {
            document.querySelectorAll('.remove-group-btn').forEach(btn => {
                btn.style.visibility = parameterGroups.length > 1 ? 'visible' : 'hidden';
            });
        }
        
        function updateRemoveRowButtons() {
            const rows = containers.employeeRows.querySelectorAll('.employee-row');
            rows.forEach(row => {
                row.querySelector('.remove-row-btn').style.visibility = rows.length > 1 ? 'visible' : 'hidden';
            });
        }

        // --- EVENT LISTENERS ---
        // Global inputs
        Object.values(globalInputs).forEach(input => input.addEventListener('input', calculateAndRenderAll));
        globalInputs.aliquotaAutomaticaSwitch.addEventListener('change', () => {
            globalInputs.aliquotaSimples.disabled = globalInputs.aliquotaAutomaticaSwitch.checked;
            globalInputs.aliquotaSimples.classList.toggle('bg-slate-100', globalInputs.aliquotaAutomaticaSwitch.checked);
            calculateAndRenderAll();
        });
        
        // Add Group Button
        buttons.addGroup.addEventListener('click', createParameterGroup);
        
        // Dynamic event delegation for Parameter Groups
        containers.parameterGroups.addEventListener('click', e => {
            const groupCard = e.target.closest('.parameter-group');
            if (!groupCard) return;

            if (e.target.closest('.expand-params-btn')) {
                const content = groupCard.querySelector('.additional-params');
                const icon = e.target.closest('.expand-params-btn').querySelector('svg');
                content.classList.toggle('expanded');
                icon.classList.toggle('rotate-180');
            }
            if (e.target.closest('.expand-category-btn')) {
                const content = e.target.closest('div').querySelector('.expandable-content');
                const icon = e.target.closest('.expand-category-btn').querySelector('svg');
                content.classList.toggle('expanded');
                icon.classList.toggle('rotate-180');
            }
            if (e.target.closest('.remove-group-btn')) {
                const groupId = parseInt(groupCard.id.split('-')[2]);
                parameterGroups = parameterGroups.filter(g => g.id !== groupId);
                groupCard.remove();
                updateAllGroupDropdowns();
                updateRemoveGroupButtons();
            }
        });
        
        containers.parameterGroups.addEventListener('input', e => {
            if (e.target.classList.contains('group-name-input')) {
                const groupId = parseInt(e.target.closest('.parameter-group').id.split('-')[2]);
                const group = parameterGroups.find(g => g.id === groupId);
                if (group) {
                    group.name = e.target.value;
                    updateAllGroupDropdowns();
                }
            } else {
                 calculateAndRenderAll();
            }
        });

        // Dynamic event delegation for Employee Rows
        containers.employeeRows.addEventListener('click', e => {
            if (e.target.closest('.add-row-btn')) createEmployeeRow();
            if (e.target.closest('.remove-row-btn')) {
                e.target.closest('.employee-row').remove();
                updateRemoveRowButtons();
                calculateAndRenderAll();
            }
        });
        containers.employeeRows.addEventListener('input', calculateAndRenderAll);

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            createParameterGroup();
            createEmployeeRow();
            globalInputs.aliquotaSimples.disabled = globalInputs.aliquotaAutomaticaSwitch.checked;
            globalInputs.aliquotaSimples.classList.toggle('bg-slate-100', globalInputs.aliquotaAutomaticaSwitch.checked);
        });
    </script>
</body>
</html>
